import re
from typing import Any, Dict, Iterable, List

DISTRICT_SOURCE = """5: Киевский
6: Малиновский
8: Приморский
11: Суворовский"""

MICROAREA_SOURCE = """89: Бугаевка
90: Дзержинского пос
91: Застава
92: Ленпоселок
93: Мельницы
94: Молдаванка
95: Сахарный пос
96: Слободка
97: Фонтан
98: Черемушки
99: Аркадия
102: Центр
103: Шевченко-Французский
104: Большевик
105: Котовского пос
106: Кривая Балка
107: Куяльник
108: Лузановка
109: Нефтяников пос
110: Пересыпь
112: Шевченко
113: Вузовский
114: Дача Ковалевского
115: Дружный ж/м
116: Таирова
118: Царское село
119: Червоный хутор
121: Черноморка
122: Чубаевка"""

STREET_SOURCE = """266969: бульв. Заболотного (область)
266985: бульв. Лидерсовский
267090: бульв. Приморский
150183: вулиця Академика Вильямса
269019: КООП. Аркадиевская аллея
268839: КООП. СК Таировское
150900: линия 1-а Лиманчик
150901: линия 1-а Люстдорфская
150903: линия 1-а Чубаевка
150902: линия 1-ая Суворовская
150882: линия 10-а Люстдорфская
150883: линия 10-я Суворовская
150884: линия 11-а Люстдорфская
150885: линия 11-я Суворовская
150886: линия 12-я Люстдорфская
150887: линия 12-я Суворовская
150888: линия 13-я 6ст. Люстдорфской дор.
150889: линия 13-я Суворовская
150890: линия 14-я Люстдорфская
150891: линия 14-я Суворовская
150892: линия 15-я Люстдорфская
150893: линия 15-я Суворовская
150895: линия 16-я Люстдорфская
150896: линия 17-я Люстдорфская
268617: линия 18-линия
150897: линия 18-я Люстдорфская
150898: линия 19-я Люстдорфская
150899: линия 19-я Суворовская
150912: линия 2-а Лиманчик
150914: линия 2-я Суворовская
150904: линия 22-я Суворовская
150905: линия 23-я Суворовская
150906: линия 24-я Суворовская
150907: линия 25-я Суворовская
150908: линия 26-я Суворовская
150909: линия 27-я Суворовская
150910: линия 28-я Суворовская
150911: линия 29-я Суворовская
150922: линия 3-а Лиманчик
150923: линия 3-а Люстдорфская
150924: линия 3-я Суворовская
150915: линия 30-я Суворовская
150916: линия 31-я Суворовская
150917: линия 32-я Суворовская
150918: линия 36-а
150919: линия 37-а
150920: линия 38-а
150921: линия 39-а
150934: линия 4-а Лиманчик
150935: линия 4-я Люстдорфская
150925: линия 41-а
150926: линия 42-а
150927: линия 43-а
150928: линия 44-а
150929: линия 45-а
150930: линия 46-а
150931: линия 47-а
150932: линия 48-а
150933: линия 49-а
150942: линия 5-а Лиманчик
150943: линия 5-я Люстдорфская
150944: линия 5-я Суворовская
150936: линия 50-а
150937: линия 51-а
150938: линия 52-а
150939: линия 53-а
150940: линия 54-а
150941: линия 55-а
150946: линия 6-я Суворовская
150948: линия 7-я Суворовская
150949: линия 8-а Лиманчик
150950: линия 8-а Люстдорфская
150951: линия 8-я Суворовская
150952: линия 9-а Лиманчик
150953: линия 9-а Люстдорфская
267857: линия Вторая линия Курортного квартала
150955: м-р Курорт Куяльник
267023: Дружный
267943: Золотой Бугаз (область)
150956: Ланжерон
150881: Радужный
267870: Солнечный
269040: набережная Лузановский Пляж
150957: Гамова
150960: Старобазарний
269255: 1- й Украинский
151002: 1-й Александра Невского
150978: 1-й Амундсена
150981: 1-й Бассейный
150985: 1-й Водопроводный
151016: 1-й Восточный
150983: 1-й Известковый
150991: 1-й Китобойный
150993: 1-й Кустанайський
151018: 1-й Майский
151000: 1-й Моторный
151004: 1-й Офицерский
151007: 1-й Проездной
151009: 1-й Равенства
269209: 1-й Сиротский
151015: 1-й Сурикова
151020: 1-й Флотский
151022: 1-й Черноморский
150972: 10-й Черноморский
150973: 11-й Черноморский
150974: 12-й Черноморский
267780: 13-й Черноморский
267373: 2-й Глазунова
151057: 2-й Александра Невского
267305: 2-й Амундсена
267108: 2-й Бассейный
151037: 2-й Водопроводный
150152: 2-й Восточный
151034: 2-й Известковый
267601: 2-й Китобойный
267581: 2-й Котовского
151047: 2-й Кустанайський
151070: 2-й Майский
151054: 2-й Моторный
151056: 2-й Обильный
267458: 2-й Офицерский
267262: 2-й Первомайский
151061: 2-й Проездной
150151: 2-й Равенства
151011: 2-й Сиротский
151067: 2-й Студенческий
151068: 2-й Сурикова
151073: 2-й Флотский
151075: 2-й Химический
151076: 2-й Черноморский
267030: 2-ой Куликовский
151098: 3-й Александра Невского
267454: 3-й Амундсена
266963: 3-й Бассейный
151086: 3-й Водопроводный
151084: 3-й Известковый
151105: 3-й Майский
151096: 3-й Моторный
151099: 3-й Проектируемый
267816: 3-й Тимирязева
151104: 3-й Тимирязева
151107: 3-й Флотский
151109: 3-й Химический
151110: 3-й Черноморский
151124: 4-й Александра Невского
151116: 4-й Бассейный
151130: 4-й Майский
151129: 4-й Тимирязева
151131: 4-й Черноморский
151113: 411-й Батареи
151143: 5-й Балтский
151132: 5-й Бассейный
151141: 5-й Майский
267671: 5-й Тимирязева
151142: 5-й Черноморский
151144: 6-й Бассейный
151149: 6-й Черноморский
151154: 7-й Черноморский
267742: 8-й Черноморский
151157: 9-й Черноморский
151158: Абрикосовый
268029: Агрономический
267888: Александра Матросова
268721: Александра Юрженко
267096: Аркадиевский
267042: Асташкина
151230: Атамана Кошевого
150976: Аэродромный
268941: Аэродромный 2-й
151166: Бадаева
267140: Банный
151168: Баркасний
267701: Белякова
267168: Бисквитный
150128: Богатского
151242: Больничный
151174: Бориса Кифоренка
151177: Ботанический
151178: Валиховский
267013: Ванный
269069: Ванцетти
267037: Ватманский
151185: Виктора Дихтиевского
267176: Вильгельма Габсбурга
151182: Виноградный
151184: Вишневый
267694: Водный
151187: Вознесенский
151189: Волжский
151191: Воронцовский
268430: Всеволода Змиенко
267024: Высокий
267649: Гагарина
267899: Газовый
267284: Гаршина
266900: Гвоздичный
150258: Генерала Вишневского
150295: Герцена
268752: Гетьманский
151039: Глазунова
267270: Глинки
151197: Госпитальный
268967: Гранатный
150315: Грузовой
151397: Дальницький
151199: Дачный
267371: Дачный 1-й
269246: Дачный 2-й
151201: Джутовый
268994: Дмитрия Донского
151202: Дорстроя
268396: Достоевского
267414: Дружбы
150355: Дунаева
151209: Елисаветградский
151211: Железнодорожный
268988: Иванова 1-й пер.
268996: Иванова 2-й пер.
151212: Игоря Киселева
267027: Интернациональный
151214: Ипподромный
150401: Испанский
267650: Каманина
151216: Канатный
268377: Кандинского 1-й пер
268378: Кандинского 2-й пер
267608: Кандинского 3-й пер
268376: Кандинского 4-й пер
267336: Кандинского 5-й пер
151217: Каретный
269421: Карпенко-Карого
267894: Картамышевский
150415: Катаева
151219: Каховский
267022: Кедровый
151302: Клубничный
151223: Книжный
267919: Ковалевского
151222: Ковровый
268789: Коллективный
267199: Компасный
151228: Кордонный
267833: Котовского
151231: Красный
269298: Красных Зорь
151229: Краткое
151233: Кренкеля
151237: Крушельницкой
267036: Курортный
267519: Курортный 1-й
267479: Курортный 2-й
267521: Курортный 4-й
267493: Курортный 5-й
150474: Леваневского
150480: Лермонтовский
150481: Лермонтовский 2-й
151244: Летний
151241: Лиманний
151243: Линейный
150958: Лодочный
151246: Ломаный
267159: Лунный
151247: Львовский
267466: Львовский 2-й
151248: Любашевский
267510: Людмилы Гинзбург
151250: Лютеранский
151252: Ляпунова
267043: Майский
151253: Маковый
150510: Маланова
151254: Манежный
151256: Машиностроительный
151257: Маяковского
151261: Месячный
150547: Митракова
268834: Мичурина
151262: Молокова
151263: Монастырский
151264: Мореходный
267050: Морской
267275: Морской 2-й
269334: Москвина
151266: Мостовой
269439: Моторный
267040: Мукачевский
151268: Навигационный
268944: Наличный 1-й
269349: Наличный 2-й
267078: Нахимова
151273: Некрасова
151269: Нефтяников 1-й
266897: Нечипуренко
151356: Николая Стражеско
267440: Обильный 1-й пер
151275: Обсерваторный
151283: Ониловой
267539: Оранжерейный
268978: Павла Кравцова
267823: Павлова
267552: Панченко
269302: Парашютный
151290: Педагогический
268954: Первомайский 1-й
268352: Первомайский 2-й
269266: Перова
269401: Пироговский
267478: Победы (обл)
267299: Подъемный
266899: Покровский
267638: Ползунова
267031: Ползунова
267929: Ползунова 1-й
267727: Ползунова 2-й
150721: Поселковый
150650: Почтовый
267443: Приморский
151125: Проектируемый 5-й
267500: Пролетарский
269061: Прорезной
267750: Просвиты
267117: Прохоровский
267643: Псковский
268518: Ровный
267614: Рулевой
267112: Сабанский
269212: Садовый
268750: Санаторный
151321: Светлый
267952: Севастопольский
267113: Северный
151326: Сельскохозяйственный
267672: Сергея Уточкина
267645: Сергея Эйзенштейна
267902: Сеченова
268931: Славы
267383: Смелый
267817: Солнечный (область)
267611: Спартаковский
151324: Среднефонтанский
151335: Староконный
268393: Сумской пер.
151398: Тераспольский
268943: Товарный
267080: Тополевый
267221: Топольского
269110: Трудовой
151344: Удельный
267681: Узкий
268762: Университетский
267028: Успенский
267683: Ушакова
267209: Ушинского
267156: Хантадзе (область)
151351: Хвойный
151235: Хрустальный
267795: Хуторской
267032: Цветочный
267063: Чайковского
269050: Черниговский
267714: Черноморский
266895: Чехова
151363: Шампанский
267318: Шахтинский
267166: Шебелинский
267591: Шевченко (область)
267357: Шевченко 1-й (область)
267587: Шевченко 2-й (область)
267905: Ширяевский
267114: Шовкуненко
267689: Шолохова
268098: Щукина
267026: Экономический
151208: Эстонский
267317: Юбилейный 1-й
269016: Юбилейный 2-й
267580: Южный
268367: Юннатов 3-й пер.
268963: Яблочкиной
268360: Якорный"""

CONDITION_MAP = {
    "под отделочные работы": 6,
    "жилая": 7,
    "евроремонт": 8,
    "от строителей": 9,
    "капитальный": 14,
    "под ремонт": 18
}

def parse_source(text: str) -> Dict[str, int]:
    result: Dict[str, int] = {}
    for raw in text.strip().splitlines():
        if ":" not in raw:
            continue
        identifier, name = raw.split(":", 1)
        key = name.strip().lower()
        if key:
            result[key] = int(identifier.strip())
    return result

DISTRICTS = parse_source(DISTRICT_SOURCE)
MICROAREAS = parse_source(MICROAREA_SOURCE)
STREETS = parse_source(STREET_SOURCE)

ROOM_PATTERN = re.compile(r"(\d+)[\s-]*(?:кімнат|комнат|room)", re.IGNORECASE)
NUMBER_PATTERN = re.compile(r"\d+[\s\d]*")

def extract_ints(text: str) -> List[int]:
    values: List[int] = []
    for match in NUMBER_PATTERN.findall(text.replace("\u00a0", "")):
        digits = re.sub(r"[^0-9]", "", match)
        if digits:
            values.append(int(digits))
    return values

def match_map(text: str, mapping: Dict[str, int]) -> List[int]:
    result: List[int] = []
    normalized = text.lower()
    for label, identifier in mapping.items():
        if label in normalized:
            result.append(identifier)
    return result

def parse_rooms(text: str) -> List[int]:
    result = [int(match.group(1)) for match in ROOM_PATTERN.finditer(text)]
    if result:
        return result
    values = extract_ints(text)
    filtered = [value for value in values if 0 < value < 8]
    return filtered

def parse_price(text: str) -> Dict[str, int]:
    values = extract_ints(text)
    if not values:
        return {}
    if len(values) == 1:
        return {"price_max": values[0]}
    return {"price_min": min(values), "price_max": max(values)}

def parse_area(text: str) -> Dict[str, int]:
    values = extract_ints(text)
    if not values:
        return {}
    filtered = [value for value in values if value > 10]
    if not filtered:
        return {}
    if len(filtered) == 1:
        return {"area_min": filtered[0]}
    return {"area_min": min(filtered), "area_max": max(filtered)}

def parse_floors(text: str) -> Dict[str, int]:
    values = extract_ints(text)
    if not values:
        return {}
    if len(values) == 1:
        return {"floor_min": values[0], "floor_max": values[0]}
    return {"floor_min": min(values), "floor_max": max(values)}

def parse_condition(text: str) -> List[int]:
    normalized = text.lower()
    result: List[int] = []
    for name, identifier in CONDITION_MAP.items():
        if name in normalized:
            result.append(identifier)
    return result

def parse_to_filters(key: str, answer: str) -> Dict[str, Any]:
    normalized = answer.lower()
    result: Dict[str, Any] = {}
    if key == "district":
        matches = match_map(normalized, DISTRICTS)
        if matches:
            result["district_id"] = matches
        micro = match_map(normalized, MICROAREAS)
        if micro:
            result["microarea_id"] = micro
        streets = match_map(normalized, STREETS)
        if streets:
            result["street_id"] = streets
    elif key == "price":
        result.update(parse_price(answer))
    elif key == "rooms":
        rooms = parse_rooms(answer)
        if rooms:
            result["rooms_in"] = rooms
    elif key == "area":
        result.update(parse_area(answer))
    elif key == "floor":
        result.update(parse_floors(answer))
    elif key == "condition":
        conditions = parse_condition(answer)
        if conditions:
            result["condition_in"] = conditions
    if not result:
        generic_districts = match_map(normalized, DISTRICTS)
        if generic_districts:
            result["district_id"] = generic_districts
        generic_micro = match_map(normalized, MICROAREAS)
        if generic_micro:
            result["microarea_id"] = generic_micro
        generic_streets = match_map(normalized, STREETS)
        if generic_streets:
            result["street_id"] = generic_streets
        if "евро" in normalized:
            result["condition_in"] = [8]
    return result

def build_summary(filters: Dict[str, Any]) -> str:
    parts: List[str] = []
    if "district_id" in filters:
        districts = filters["district_id"]
        labels = _labels_from_ids(districts, DISTRICTS)
        parts.append(f"Район: {', '.join(labels)}")
    if "microarea_id" in filters:
        micro = filters["microarea_id"]
        labels = _labels_from_ids(micro, MICROAREAS)
        parts.append(f"Мікрорайон: {', '.join(labels)}")
    if "street_id" in filters:
        streets = filters["street_id"]
        labels = _labels_from_ids(streets, STREETS)
        parts.append(f"Вулиця: {', '.join(labels)}")
    if "rooms_in" in filters:
        rooms = ", ".join(str(value) for value in filters["rooms_in"])
        parts.append(f"Кімнати: {rooms}")
    if "price_min" in filters or "price_max" in filters:
        low = filters.get("price_min")
        high = filters.get("price_max")
        if low and high:
            parts.append(f"Бюджет: {low}-{high}")
        elif high:
            parts.append(f"Бюджет до {high}")
        elif low:
            parts.append(f"Бюджет від {low}")
    if "area_min" in filters or "area_max" in filters:
        low = filters.get("area_min")
        high = filters.get("area_max")
        if low and high:
            parts.append(f"Площа: {low}-{high}")
        elif high:
            parts.append(f"Площа до {high}")
        elif low:
            parts.append(f"Площа від {low}")
    return "\n".join(parts)

def _labels_from_ids(values: Iterable[int], mapping: Dict[str, int]) -> List[str]:
    reverse = {identifier: name for name, identifier in mapping.items()}
    return [reverse.get(value, str(value)) for value in values]
